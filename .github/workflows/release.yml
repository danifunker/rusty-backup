name: Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - "*.md"
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  generate-version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Generate version from date
        id: version
        run: |
          VERSION=$(date -u +"%Y-%m-%d-%H-%M")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

  build-windows:
    name: Build Windows
    needs: generate-version
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: i686-pc-windows-msvc
            arch: x86
          - target: x86_64-pc-windows-msvc
            arch: x64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        env:
          RELEASE_VERSION: ${{ needs.generate-version.outputs.version }}
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Package
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          if [ -f "../../../assets/icons/icon.ico" ]; then
            7z a ../../../Rusty-Backup-windows-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.zip rusty-backup.exe ../../../assets/icons/icon.ico
          else
            7z a ../../../Rusty-Backup-windows-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.zip rusty-backup.exe
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-windows-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}
          path: Rusty-Backup-windows-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.zip

  build-macos:
    name: Build macOS
    needs: generate-version
    runs-on: macos-latest
    env:
      HAS_SIGNING_CERT: ${{ secrets.MACOS_CERTIFICATE != '' }}
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        env:
          RELEASE_VERSION: ${{ needs.generate-version.outputs.version }}
        run: |
          # Build main app
          cargo build --release --target ${{ matrix.target }}
      
      - name: Import signing certificate
        if: ${{ env.HAS_SIGNING_CERT == 'true' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PWD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$MACOS_CERTIFICATE" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          rm "$CERT_PATH"

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Create macOS app bundle
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_TEAM_ID: ${{ secrets.MACOS_TEAM_ID }}
        run: |
          APP_NAME="Rusty Backup"
          BUNDLE_NAME="Rusty Backup.app"
          VERSION="${{ needs.generate-version.outputs.version }}"

          # Create app bundle structure
          mkdir -p "${BUNDLE_NAME}/Contents/MacOS"
          mkdir -p "${BUNDLE_NAME}/Contents/Resources"

          # Copy main binary
          cp "target/${{ matrix.target }}/release/rusty-backup" "${BUNDLE_NAME}/Contents/MacOS/"
          chmod +x "${BUNDLE_NAME}/Contents/MacOS/rusty-backup"

          # Copy icon if available
          if [ -f "assets/icons/icon.icns" ]; then
            cp "assets/icons/icon.icns" "${BUNDLE_NAME}/Contents/Resources/AppIcon.icns"
          fi

          # Create Info.plist
          cat > "${BUNDLE_NAME}/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundleDisplayName</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>io.github.dani.rusty-backup</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleExecutable</key>
              <string>rusty-backup</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon.icns</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
          </dict>
          </plist>
          EOF

          # Code sign: use Developer ID if available, otherwise ad-hoc
          if [ -n "$MACOS_CERTIFICATE" ] && [ -n "$MACOS_TEAM_ID" ]; then
            echo "Signing with Developer ID certificate..."
            codesign --force --options runtime --sign "Developer ID Application: ($MACOS_TEAM_ID)" "${BUNDLE_NAME}"
          else
            echo "No signing certificate found, using ad-hoc signature..."
            codesign --force --deep --sign - "${BUNDLE_NAME}"
          fi

          # Create DMG
          hdiutil create -volname "${APP_NAME}" -srcfolder "${BUNDLE_NAME}" -ov -format UDZO "Rusty-Backup-macos-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.dmg"

          # Sign the DMG as well if certificate is available
          if [ -n "$MACOS_CERTIFICATE" ] && [ -n "$MACOS_TEAM_ID" ]; then
            codesign --force --sign "Developer ID Application: ($MACOS_TEAM_ID)" "Rusty-Backup-macos-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.dmg"
          fi

      - name: Notarize DMG
        if: ${{ env.HAS_SIGNING_CERT == 'true' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_NOTARIZE_APPLE_ID: ${{ secrets.MACOS_NOTARIZE_APPLE_ID }}
          MACOS_NOTARIZE_PASSWORD: ${{ secrets.MACOS_NOTARIZE_PASSWORD }}
          MACOS_TEAM_ID: ${{ secrets.MACOS_TEAM_ID }}
        run: |
          DMG_FILE="Rusty-Backup-macos-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.dmg"

          echo "Submitting for notarization..."
          xcrun notarytool submit "$DMG_FILE" \
            --apple-id "$MACOS_NOTARIZE_APPLE_ID" \
            --password "$MACOS_NOTARIZE_PASSWORD" \
            --team-id "$MACOS_TEAM_ID" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_FILE"

      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-macos-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}
          path: Rusty-Backup-macos-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.dmg

  build-linux-appimage:
    name: Build Linux AppImage
    needs: generate-version
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x64
            runs-on: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            arch: arm64
            runs-on: [self-hosted, linux, ARM64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (GitHub-hosted only)
        if: ${{ !contains(matrix.runs-on, 'self-hosted') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libssl-dev pkg-config

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        env:
          RELEASE_VERSION: ${{ needs.generate-version.outputs.version }}
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Download AppImage tools
        run: |
          if [ "${{ matrix.arch }}" = "x64" ]; then
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
            chmod +x appimagetool-x86_64.AppImage
            # Extract appimagetool to avoid FUSE requirement
            ./appimagetool-x86_64.AppImage --appimage-extract
            mv squashfs-root/AppRun squashfs-root/appimagetool
            chmod +x squashfs-root/appimagetool
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
            chmod +x appimagetool-aarch64.AppImage
            ./appimagetool-aarch64.AppImage --appimage-extract
            mv squashfs-root/AppRun squashfs-root/appimagetool
            chmod +x squashfs-root/appimagetool
          fi
      
      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp target/${{ matrix.target }}/release/rusty-backup AppDir/usr/bin/
          
          # Create proper .desktop file with all required fields
          cat > AppDir/usr/share/applications/rusty-backup.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=Rusty Backup
          Comment=Backup and restore vintage computer hard disk images
          Exec=rusty-backup
          Icon=rusty-backup
          Categories=Utility;System;
          Terminal=false
          StartupNotify=true
          EOF
          
          # Copy icon with proper naming
          if [ -f "assets/icons/icon-256.png" ]; then
            cp assets/icons/icon-256.png AppDir/usr/share/icons/hicolor/256x256/apps/rusty-backup.png
            # Also copy to root for AppImage (some systems need this)
            cp assets/icons/icon-256.png AppDir/rusty-backup.png
          fi
          
          # Copy .desktop file to root (required for AppImage)
          cp AppDir/usr/share/applications/rusty-backup.desktop AppDir/
          
          # Create AppRun as symlink to the binary
          ln -s usr/bin/rusty-backup AppDir/AppRun
          
          # Use extracted appimagetool with --no-appstream to avoid FUSE requirement
          ARCH=${{ matrix.arch }} ./squashfs-root/appimagetool --no-appstream AppDir Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.AppImage
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}-appimage
          path: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.AppImage

  build-linux-packages:
    name: Build Linux Packages
    needs: generate-version
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x64
            runs-on: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            arch: arm64
            runs-on: [self-hosted, linux, ARM64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (GitHub-hosted only)
        if: ${{ !contains(matrix.runs-on, 'self-hosted') }}
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libssl-dev pkg-config dpkg-dev liblzma-dev rpm libarchive-tools zstd

      - name: Install cargo packaging tools
        run: |
          cargo install cargo-deb || true
          cargo install cargo-generate-rpm || true
          cargo install cargo-aur || true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        env:
          RELEASE_VERSION: ${{ needs.generate-version.outputs.version }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build Debian package
        run: |
          cargo deb --target ${{ matrix.target }} --no-build
          mv target/${{ matrix.target }}/debian/*.deb Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.deb

      - name: Build RPM package
        run: |
          cargo generate-rpm --target ${{ matrix.target }}
          mv target/${{ matrix.target }}/generate-rpm/*.rpm Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.rpm

      - name: Build Arch package
        run: |
          cargo aur
          # cargo-aur generates PKGBUILD, build with makepkg equivalent
          mkdir -p arch-build
          cp target/release/rusty-backup arch-build/
          cp rusty-backup.desktop arch-build/
          cp -r assets arch-build/
          cd arch-build
          
          # Create a simple package structure
          mkdir -p pkg/usr/bin
          mkdir -p pkg/usr/share/applications
          mkdir -p pkg/usr/share/icons/hicolor/{16x16,32x32,48x48,64x64,128x128,256x256}/apps
          
          cp rusty-backup pkg/usr/bin/
          chmod 755 pkg/usr/bin/rusty-backup
          cp rusty-backup.desktop pkg/usr/share/applications/
          cp assets/icons/icon-16.png pkg/usr/share/icons/hicolor/16x16/apps/rusty-backup.png
          cp assets/icons/icon-32.png pkg/usr/share/icons/hicolor/32x32/apps/rusty-backup.png
          cp assets/icons/icon-48.png pkg/usr/share/icons/hicolor/48x48/apps/rusty-backup.png
          cp assets/icons/icon-64.png pkg/usr/share/icons/hicolor/64x64/apps/rusty-backup.png
          cp assets/icons/icon-128.png pkg/usr/share/icons/hicolor/128x128/apps/rusty-backup.png
          cp assets/icons/icon-256.png pkg/usr/share/icons/hicolor/256x256/apps/rusty-backup.png
          
          # Create package with tar and zstd
          cd pkg
          tar -czf ../../Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.pkg.tar.zst *

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}-deb
          path: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.deb

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}-rpm
          path: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.rpm

      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}-arch
          path: Rusty-Backup-linux-${{ matrix.arch }}-${{ needs.generate-version.outputs.version }}.pkg.tar.zst

  release:
    name: Create Release
    needs: [generate-version, build-windows, build-macos, build-linux-appimage, build-linux-packages]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Flatten artifacts
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.zip" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.pkg.tar.zst" \) -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.generate-version.outputs.version }}
          name: Release ${{ needs.generate-version.outputs.version }}
          files: release-files/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
